<table class="table js-datagrid-table" data-datagrid="{{ name|replace({'\\': '_'}) }}">
    <thead>
    <tr>
        {% for column in columns %}
            <td>
                {% if column.filterable %}
                    {{ datagrid_filter(column.filter, column.name, loop.index0) }}
                {% endif %}
            </td>
        {% endfor %}
        {% if actionColumn.hasActions() %}
            <td></td>
        {% endif %}
    </tr>
    <tr>
        {% for column in columns %}
            <th data-name="{{ column.name }}" data-orderable="{{ column.sortable ? 'true' : 'false' }}">
                {{ column.label }}
            </th>
        {% endfor %}
        {% if actionColumn.hasActions() %}
            <th data-orderable="false"></th>
        {% endif %}
    </tr>
    </thead>
</table>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const table = $('.js-datagrid-table[data-datagrid="{{ name|replace({'\\': '_'}) }}"]').DataTable({
            processing: true,
            serverSide: true,
            pageLength: {{ default.perPage }},
            order: [[{{ default.sortIndex }}, '{{ default.sortDir }}']],
            ajax: '{{ path('datagrid_ajax', {name: name}) }}'
        });

        const container = $(table.table().container());

        let timeout = null;

        container.on('keyup', 'thead input', function () {
            const self = $(this);
            clearTimeout(timeout);
            timeout = setTimeout(function () {
                table
                    .column(self.data('index'))
                    .search(self.val())
                    .draw();
            }, 200);
        });

        container.on('change', 'thead select', function () {
            const self = $(this);
            table
                .column(self.data('index'))
                .search(self.val())
                .draw();
        });

        container.find('thead .js-datagrid-flatpickr').each(function () {
            const self = $(this);
            flatpickr(this, {
                dateFormat: 'd.m.Y',
                locale: 'cs',
                onChange: function (selectedDates) {
                    if (selectedDates.length === 2) {
                        table
                            .column(self.data('index'))
                            .search(self.val())
                            .draw();
                    }
                }
            });
        });

        {% if allowExport %}
            const exportBtn = $('<a href="#">Export</a>').on('click', function (e) {
                e.preventDefault();
                window.open('{{ path('datagrid_export', {name: name}) }}?' + $.param(table.ajax.params()), '_blank');
            });

            container.find('.dataTables_filter').html(exportBtn);
        {% else %}
            container.find('.dataTables_filter').html('');
        {% endif %}
    });
</script>